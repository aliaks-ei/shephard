<template>
  <q-dialog
    :model-value="modelValue"
    :transition-show="$q.screen.lt.md ? 'slide-up' : 'scale'"
    :transition-hide="$q.screen.lt.md ? 'slide-down' : 'scale'"
    :maximized="$q.screen.xs"
    :full-width="$q.screen.xs"
    :full-height="$q.screen.xs"
    @update:model-value="emit('update:modelValue', $event)"
  >
    <q-card
      class="column"
      :class="$q.screen.lt.md ? 'full-height' : ''"
    >
      <q-card-section class="row items-center">
        <q-icon
          name="eva-share-outline"
          :size="$q.screen.lt.md ? '20px' : '24px'"
          class="q-mr-sm"
        />
        <h2
          class="q-my-none"
          :class="$q.screen.lt.md ? 'text-subtitle2' : 'text-h6'"
        >
          Share {{ entityName }}
        </h2>
        <q-space />
        <q-btn
          icon="eva-close-outline"
          flat
          round
          dense
          :size="$q.screen.lt.md ? 'sm' : 'md'"
          @click="closeDialog"
        />
      </q-card-section>

      <q-separator />

      <q-card-section class="q-pt-md col overflow-auto">
        <div class="q-mb-lg">
          <div class="text-subtitle2 q-mb-sm">
            <q-icon
              name="eva-people-outline"
              class="q-mr-xs"
            />
            People with access
            <q-chip
              v-if="!isLoadingShares && sharedUsers.length > 0"
              color="primary"
              text-color="white"
              size="sm"
              class="q-ml-sm"
            >
              {{ sharedUsers.length }}
            </q-chip>
          </div>

          <div v-if="isLoadingShares">
            <q-list
              bordered
              class="rounded-borders"
            >
              <q-item class="q-py-xs q-px-sm">
                <q-item-section avatar>
                  <q-skeleton
                    type="QAvatar"
                    size="32px"
                  />
                </q-item-section>
                <q-item-section>
                  <q-skeleton
                    type="text"
                    width="60%"
                  />
                  <q-skeleton
                    type="text"
                    width="80%"
                  />
                  <q-skeleton
                    type="text"
                    width="40%"
                  />
                </q-item-section>
                <q-item-section side>
                  <div class="row items-center q-gutter-sm">
                    <q-skeleton
                      type="QBtn"
                      width="100px"
                      height="32px"
                    />
                    <q-skeleton
                      type="QBtn"
                      width="32px"
                      height="32px"
                    />
                  </div>
                </q-item-section>
              </q-item>
            </q-list>
          </div>

          <div v-else-if="sharedUsers.length > 0">
            <SharedUsersList
              :users="sharedUsers"
              :permission-options="permissionOptions"
              @update:user-permission="handleUpdateUserPermission"
              @remove:user="handleRemoveUserAccess"
            />
          </div>

          <div
            v-else
            class="text-center q-py-md text-grey-6"
          >
            <q-icon
              name="eva-people-outline"
              size="2rem"
              class="q-mb-sm"
            />
            <div>This {{ entityName.toLowerCase() }} is not shared with anyone yet</div>
          </div>
        </div>

        <div class="q-mb-lg">
          <div class="text-subtitle2 q-mb-sm">
            <q-icon
              name="eva-person-add-outline"
              class="q-mr-xs"
            />
            Add people
          </div>

          <SharedUsersSelect
            v-model="selectedUsers"
            :current-user-id="currentUserId"
            :search-results="userSearchResults"
            :shared-users="sharedUsers"
            :loading="isSearchingUsers"
            @update:search-query="debouncedSearch"
          />

          <div class="text-caption text-grey-6 q-mt-sm">
            Search for existing users to share this {{ entityName.toLowerCase() }} with
          </div>
        </div>

        <div v-if="selectedUsers.length > 0">
          <div class="text-subtitle2 q-mb-sm">
            <q-icon
              name="eva-shield-outline"
              class="q-mr-xs"
            />
            Access level for selected users
          </div>
          <q-option-group
            v-model="selectedPermission"
            :options="permissionOptions"
            color="primary"
            class="q-mb-lg"
            inline
          />
        </div>
      </q-card-section>

      <q-card-actions
        align="right"
        class="q-pa-md q-mt-auto"
      >
        <q-btn
          label="Cancel"
          flat
          no-caps
          @click="closeDialog"
        />
        <q-btn
          label="Share"
          color="primary"
          unelevated
          no-caps
          :loading="isLoading || isSharing"
          :disable="selectedUsers.length === 0"
          @click="handleShare"
        />
      </q-card-actions>
    </q-card>
  </q-dialog>
</template>

<script setup lang="ts">
import { ref, watch, computed } from 'vue'
import { useDebounceFn } from '@vueuse/core'
import { useQuasar } from 'quasar'

import SharedUsersList from 'src/components/shared/SharedUsersList.vue'
import SharedUsersSelect from 'src/components/shared/SharedUsersSelect.vue'
import { useUserStore } from 'src/stores/user'
import type { UserSearchResult, TemplateSharedUser } from 'src/api'

const $q = useQuasar()

type SharedUser = TemplateSharedUser


const userStore = useUserStore()

const permissionOptions = [
  { label: 'Can view', value: 'view' },
  { label: 'Can edit', value: 'edit' },
]

const selectedPermission = ref<'view' | 'edit'>('view')
const selectedUsers = ref<UserSearchResult[]>([])
const isLoading = ref(false)
const isLoadingShares = ref(false)

const currentUserId = computed(() => userStore.userProfile?.id)

const debouncedSearch = useDebounceFn((query: string) => {
  if (!query.trim()) {
    props.clearUserSearch()
    return
  }
  props.searchUsers(query)
}, 300)

function closeDialog() {
  emit('update:modelValue', false)
}

function reset() {
  selectedPermission.value = 'view'
  selectedUsers.value = []
  isLoadingShares.value = false
  props.clearUserSearch()
}

async function handleShare() {
  if (selectedUsers.value.length === 0) return

  isLoading.value = true

  try {
    // Share with each user and await results
    const sharePromises = selectedUsers.value.map((user) =>
      props.shareWithUser(props.entityId, user.email, selectedPermission.value),
    )

    const results = await Promise.all(sharePromises)

    // Check if all shares succeeded
    const allSucceeded = results.every((result) => result.success)

    if (allSucceeded) {
      selectedUsers.value = []
      props.clearUserSearch()
      emit('shared')
    }
    // Errors already shown by store methods
  } finally {
    isLoading.value = false
  }
}

async function handleUpdateUserPermission(userId: string, permission: 'view' | 'edit') {
  await props.updateUserPermission(props.entityId, userId, permission)
  // Error notification already shown by store
}

async function handleRemoveUserAccess(userId: string) {
  await props.removeUserAccess(props.entityId, userId)
  // Error notification already shown by store
}

watch(
  () => props.modelValue,
  async (isOpen) => {
    if (!isOpen || !props.entityId) {
      reset()
      return
    }

    isLoadingShares.value = true
    await props.loadSharedUsers(props.entityId)
    isLoadingShares.value = false
  },
  { immediate: true },
)
</script>
